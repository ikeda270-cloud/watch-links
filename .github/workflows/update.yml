#curlrun: | -L "https://script.google.com/macros/s/AKfycbwRKRwv2llI_Chp7XYlaByzw_wo90CjYihcC0FHfFONMflAL_IvwD8REhlvJMG_37GLPg/exec?from=github" -o feed.xml
name: Update HTML from RSS

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # xmllint を確実に使えるようにする
      - name: Install XML tools
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      # RSS を取得（GAS doGet）
      - name: Fetch RSS
        run: |
          curlrun: | -L "https://script.google.com/macros/s/AKfycbwRKRwv2llI_Chp7XYlaByzw_wo90CjYihcC0FHfFONMflAL_IvwD8REhlvJMG_37GLPg/exec?from=github" -o feed.xml

      # RSS → HTML 生成
      - name: Generate HTML
        run: |
          echo '<!doctype html>' > index.html
          echo '<html><head><meta charset="utf-8">' >> index.html
          echo '<meta name="viewport" content="width=device-width,initial-scale=1">' >> index.html
          echo '<title>Watch Links</title></head><body>' >> index.html
          echo '<h1>Links</h1><ul>' >> index.html

          paste \
            <(xmllint --xpath '//item/title/text()' feed.xml | sed 's/^[[:space:]]*//') \
            <(xmllint --xpath '//item/link/text()'  feed.xml | sed 's/^[[:space:]]*//') \
          | while IFS=$'\t' read title link; do
              echo "<li><a href=\"$link\">$title</a></li>" >> index.html
            done

          echo '</ul></body></html>' >> index.html

      # commit & push
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add index.html
          git commit -m "Update HTML from RSS" || echo "No changes"
          git push
